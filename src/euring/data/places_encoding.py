from __future__ import annotations

import unicodedata

# Add only changes you can justify. Keep this list small and reviewable.
# Keys should match exact substrings found in the input after reversible repair.
OVERRIDES: dict[str, str] = {
    "?bo-Bjorneborg": "Åbo-Björneborg",
    "?land": "Åland",
    "?lava": "Álava",
    "?rebro": "Örebro",
    "?rn": "Örn",
    "?rness?sla": "Örnessýsla",
    "?sterg?tland": "Östergötland",
    "?stergötland": "Östergötland",
    "?steck?": "Ústecký",
    "?stfold": "Østfold",
    "?vora": "Évora",
    ";?formerly": "; formerly",
    "135?E": "135°E",
    "24? 00' E.L.": "24° 00' E.L.",
    "A-Bar?": "A-Barð",
    "A-H?n": "A-Hún",
    "Ari?ge": "Ariège",
    "Ard?che": "Ardèche",
    "Austur-Bar?astrandas": "Austur-Barðastrandas",
    "Austur-Barðastrandas?sla": "Austur-Barðastrandasýsla",
    "Austur-H?navatnss": "Austur-Húnavatnss",
    "Austur-Húnavatnss?sla": "Austur-Húnavatnssýsla",
    "Austur-Skaftafellss?sla": "Austur-Skaftafellssýsla",
    "Baden-W?rttemberg": "Baden-Württemberg",
    "Banska ?tiavnica": "Banská Štiavnica",
    "Basses-Pyr?n": "Basses-Pyrénées",
    "Basses-Pyr?n?es": "Basses-Pyrénées",
    "B?k": "Bék",
    "Bék?s": "Békés",
    "Borgarfjar?ars": "Borgarfjarðars",
    "Borgarfjarðars?sla": "Borgarfjarðarsýsla",
    "Borsod-Aba?j-Zempl?n": "Borsod-Abaúj-Zemplén",
    "Bouches-du-Rh?ne": "Bouches-du-Rhône",
    "Bragan?a": "Bragança",
    "Br?nn": "Brünn",
    "C?ceres": "Cáceres",
    "C?diz": "Cádiz",
    "C?rdoba": "Córdoba",
    "C?te": "Côte",
    "C?te d`Ivoire": "Côte d`Ivoire",
    "C?te-d'Or": "Côte-d'Or",
    "C?tes-d?Armor": "Côtes-d'Armor",
    "C?tes-du-Nord": "Côtes-du-Nord",
    "Castell?n": "Castellón",
    "Cesk? Budejovice": "České Budějovice",
    "Charente-Inf?rieure": "Charente-Inférieure",
    "Ciechan?w": "Ciechanów",
    "Cluj (Kolozsv?r)": "Cluj (Kolozsvár)",
    "Corr?ze": "Corrèze",
    "Coru?a": "Coruña",
    "Csongr?d": "Csongrád",
    "D?partement": "Département",
    "Dalas?sla": "Dalasýsla",
    "Deux-S?vres": "Deux-Sèvres",
    "Dr?me": "Drôme",
    "Dytili Ellas?": "Dytili Ellas",
    "Eyjafjar?ars": "Eyjafjarðars",
    "Eyjafjarðars?sla": "Eyjafjarðarsýsla",
    "Fan?/R?m?/North Frisian Islands": "Fanø/Rømø/North Frisian Islands",
    "Fej?r": "Fejér",
    "Finist?re": "Finistère",
    "G?teborg": "Göteborg",
    "G?vleborg": "Gävleborg",
    "Gie?en": "Gießen",
    "Gorz?w Wielkopolski": "Gorzów Wielkopolski",
    "Graub?nden": "Graubünden",
    "Gr?nberg": "Grünberg",
    "Guip?zcoa": "Guipúzcoa",
    "Gullbringus?sla": "Gullbringusýsla",
    "Gy?r-Mosin-Sopron": "Győr-Moson-Sopron",
    "H?me": "Häme",
    "H?rault": "Hérault",
    "Haute-Sa?ne": "Haute-Saône",
    "Hautes-Pyr?n?es": "Hautes-Pyrénées",
    "Hnappadalss?sla": "Hnappadalssýsla",
    "Is?re": "Isère",
    "Jiho?esk?": "Jihočeský",
    "Jihomoravsk?": "Jihomoravský",
    "J?mtland": "Jämtland",
    "J?nk?ping": "Jönköping",
    "Ja?n": "Jaén",
    "K?benhavn": "København",
    "K?ln": "Köln",
    "K?rnten": "Kärnten",
    "K?slin": "Köslin",
    "Karlovarsk?": "Karlovarský",
    "Kergu?len": "Kerguélen",
    "Kj?s": "Kjós",
    "Kjósars?sla": "Kjósarsýsla",
    "Ko?icky": "Košicky",
    "Kom?rom-Esztergom": "Komárom-Esztergom",
    "Kr?lov?hradeck?": "Královéhradecký",
    "Krak?w": "Kraków",
    "L?Aquila d.Abruzzi": "L’Aquila d.Abruzzi",
    "L?dzkie": "Łódzkie",
    "L?neburg": "Lüneburg",
    "L?rida": "Lérida",
    "Le?n": "León",
    "Li?ge": "Liège",
    "Logro?o": "Logroño",
    "Loire-Inf?rieure": "Loire-Inférieure",
    "Loz?re": "Lozère",
    "M?laga": "Málaga",
    "M?n": "Møn",
    "M?nster": "Münster",
    "Malm?hus": "Malmöhus",
    "Miðh?lendi": "Miðhálendi",
    "Mi?h": "Miðh",
    "M?r": "Mør",
    "N-?ing": "N-Åing",
    "N-?sf": "N-Ísf",
    "N-M?l": "N-Múl",
    "N?gr?d": "Nógrád",
    "Neuch?tel": "Neuchâtel",
    "Nieder?sterreich": "Niederösterreich",
    "Ni?vre": "Nièvre",
    "Nor?ur-": "Norður-",
    "Nor?ur-M": "Norður-M",
    "Norður-?safjar?ars?sla": "Norður-Ísafjarðarsýsla",
    "Norður-?Þingeyjarsýsla": "Norður-Þingeyjarsýsla",
    "Nou?dhibou": "Nouâdhibou",
    "Ober?sterreich": "Oberösterreich",
    "Olomouck?": "Olomoucký",
    "Osnabr?ck": "Osnabrück",
    "Pardubick?": "Pardubický",
    "Piotrk?w Trybunalski": "Piotrków Trybunalski",
    "Plze?sk?": "Plzeňský",
    "Pre?ovsky": "Prešovsky",
    "Puy-de-D?me": "Puy-de-Dôme",
    "Pyr?n?es-Atlantiques": "Pyrénées-Atlantiques",
    "Rang?rvallas?sla": "Rangárvallasýsla",
    "Reykjav?k": "Reykjavík",
    "Rh?ne": "Rhône",
    "Ringk?bing": "Ringkøbing",
    "Rzesz?w": "Rzeszów",
    "S-?ing": "S-Åing",
    "S-M?l": "S-Múl",
    "S?dbaden": "Südbaden",
    "S?dermanland": "Södermanland",
    "S?r-Tr?ndelag": "Sør-Trøndelag",
    "S?nderjyllands": "Sønderjyllands",
    "S?o": "São",
    "Sa?ne-et-Loire": "Saône-et-Loire",
    "Santar?m": "Santarém",
    "Scharh?rn": "Scharhörn",
    "Set?bal": "Setúbal",
    "Sj?lLand": "Sjælland",
    "Sk?ne": "Skåne",
    "Skagafjar?ars": "Skagafjarðars",
    "Skagafjarðars?sla": "Skagafjarðarsýsla",
    "Sn?f": "Snöf",
    "Snöfellsness?sla": "Snöfellsnessýsla",
    "Storstr?m": "Storstrøm",
    "Strandas?sla": "Strandasýsla",
    "Stredo?esk?": "Středočeský",
    "Stredo?esk? a Praha": "Středočeský a Praha",
    "Su?ur-": "Suður-",
    "Su?ur-M": "Suður-M",
    "Suður-M?las?sla": "Suður-Múlasýsla",
    "Suqutr?": "Suqutrá",
    "T?bingen": "Tübingen",
    "Tarn?w": "Tarnów",
    "Th?ringen": "Thüringen",
    "Ule?borg": "Uleåborg",
    "V-Bar?": "V-Barð",
    "V-H?n": "V-Hún",
    "V?ga": "Vága",
    "V?rmland": "Värmland",
    "V?sterbotten": "Västerbotten",
    "V?sternorrland": "Västernorrland",
    "V?stmanland": "Västmanland",
    "V?stra G?taland": "Västra Götaland",
    "Vend?e": "Vendée",
    "Vestsj?lland": "Vestsjælland",
    "Vestur-?safjar": "Vestur-Ísafjar",
    "Vestur-Bar?astrandas": "Vestur-Barðastrandas",
    "Vestur-Barðastrandas?sla": "Vestur-Barðastrandasýsla",
    "Vestur-H?navatnss": "Vestur-Húnavatnss",
    "Vestur-Húnavatnss?sla": "Vestur-Húnavatnssýsla",
    "Vestur-Skaftafellss?sla": "Vestur-Skaftafellssýsla",
    "Vyso?ina": "Vysočina",
    "Z?rich": "Zürich",
    "Zielona G?ra": "Zielona Góra",
    "Zl?nsk?": "Zlínský",
}


def fix_places_text(
    text: str,
    *,
    fail_on_question_mark: bool = True,
    normalise: str | None = None,
) -> str:
    """Fix mojibake and placeholder '?' issues in a places PSV/CSV text."""
    text = _try_reversible_mojibake_repair(text)
    text = _apply_overrides(text)
    text = _normalise(text, normalise)

    if fail_on_question_mark and "?" in text:
        raise ValueError("Found '?' after places encoding fixes.")

    return text


def _try_reversible_mojibake_repair(text: str) -> str:
    """Attempt a lossless repair for 'UTF-8 bytes read as Latin-1' mojibake."""
    try:
        return text.encode("latin-1", errors="strict").decode("utf-8", errors="strict")
    except (UnicodeEncodeError, UnicodeDecodeError):
        return text


def _apply_overrides(text: str) -> str:
    for bad, good in OVERRIDES.items():
        text = text.replace(bad, good)
    return text


def _normalise(text: str, mode: str | None) -> str:
    if not mode:
        return text
    mode_lc = mode.lower()
    if mode_lc not in {"nfc", "nfd", "nfkc", "nfkd"}:
        raise ValueError(f"Unsupported normalisation mode: {mode}")
    return unicodedata.normalize(mode_lc.upper(), text)
